generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum Role {
  ADMIN
  MANAGER
  USER
}

enum PurchaseStatus {
  DRAFT
  ORDERED
  IN_TRANSIT // En route (Import)
  CUSTOMS    // Sous douane
  RECEIVED   // Réceptionné
  CANCELLED
}

enum SaleStatus {
  DRAFT
  VALIDATED
  SHIPPED
  DELIVERED
  RETURNED
  CANCELLED
}

enum PaymentMethod {
  CASH
  CHECK
  BANK_TRANSFER
  CREDIT
}

enum PaymentStatus {
  PENDING
  PARTIAL
  PAID
  OVERDUE
}

// 1. User Management
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String?
  role      Role     @default(USER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  sales     Sale[]
  purchases Purchase[]
}

// 2. Settings & CRM
model Settings {
  id          String @id @default(uuid())
  companyName String
  currency    String @default("DZD")
  taxRate     Float  @default(19.0)
}

model Supplier {
  id        String   @id @default(uuid())
  name      String
  email     String?
  phone     String?
  address   String?
  country   String?
  taxId     String? // NIF/NIS
  createdAt DateTime @default(now())
  
  purchases Purchase[]
}

model Customer {
  id        String   @id @default(uuid())
  name      String
  email     String?
  phone     String?
  address   String?
  type      String? // Wholesale, Pharmacy, Hospital
  taxId     String?
  creditLimit Float?
  createdAt DateTime @default(now())

  sales Sale[]
}

// 3. Inventory System (Medical + Multi-Depot)
model Warehouse {
  id        String   @id @default(uuid())
  name      String   // e.g., "Depot Central", "Showroom"
  location  String?
  type      String   @default("STORAGE") 
  
  stocks    Stock[]
  toTransfers   Transfer[] @relation("ToWarehouse")
  fromTransfers Transfer[] @relation("FromWarehouse")
  sales         Sale[]
}

model Category {
  id          String    @id @default(uuid())
  name        String
  description String?
  products    Product[]
}

model Unit {
  id     String @id @default(uuid())
  name   String // e.g., "Boite de 50", "Carton"
  symbol String // "BTE", "PCS"
  
  products Product[]
}

model Product {
  id          String   @id @default(uuid())
  sku         String   @unique // Barcode/Reference
  name        String
  description String?
  minStock    Int      @default(10)
  
  // Medical & Import Specifics
  originCountry String?
  hsCode        String?  // Code Douanier
  requiresPrescription Boolean @default(false)
  hasExpiry     Boolean  @default(true) // Tracks if batch expiry is mandatory

  // Pricing
  purchasePrice Float    @default(0)
  sellingPrice  Float    @default(0)
  tva           Float?   // Optional TVA rate for this specific product (e.g. 19, 9, or 0)
  
  // Relations
  categoryId  String?
  category    Category? @relation(fields: [categoryId], references: [id])
  unitId      String?
  unit        Unit?     @relation(fields: [unitId], references: [id])
  
  stocks      Stock[]
  batches     Batch[]
  
  purchaseItems PurchaseItem[]
  saleItems     SaleItem[]
  transferItems TransferItem[]
}

model Batch {
  id             String    @id @default(uuid())
  batchNumber    String    // Numéro de lot
  manufactureDate DateTime?
  expiryDate     DateTime?
  
  productId      String
  product        Product   @relation(fields: [productId], references: [id])
  
  stocks         Stock[]
  purchaseItems  PurchaseItem[]
  saleItems      SaleItem[]
  
  createdAt      DateTime  @default(now())

  @@unique([productId, batchNumber]) // Unique batch number per product
}

// The core record of "What is Where"
model Stock {
  id          String   @id @default(uuid())
  quantity    Int      @default(0)
  
  warehouseId String
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id])
  
  productId   String
  product     Product   @relation(fields: [productId], references: [id])
  
  batchId     String?   // Optional if product doesn't have batches (e.g. office supplies)
  batch       Batch?    @relation(fields: [batchId], references: [id])

  updatedAt   DateTime @updatedAt
  
  @@unique([warehouseId, productId, batchId])
}

// 4. Transactions

// Import / Purchase
model Purchase {
  id            String         @id @default(uuid())
  reference     String         @unique // PO Number
  status        PurchaseStatus @default(DRAFT)
  date          DateTime       @default(now())
  
  // Costs (Landed Cost Calculation)
  subTotal      Float
  taxTotal      Float
  shippingCost  Float          @default(0)
  customsFees   Float          @default(0) // Droits de douane
  otherFees     Float          @default(0)
  totalAmount   Float

  supplierId    String
  supplier      Supplier       @relation(fields: [supplierId], references: [id])
  userId        String
  user          User           @relation(fields: [userId], references: [id])
  
  items         PurchaseItem[]
  payments      Payment[]
}

model PurchaseItem {
  id          String   @id @default(uuid())
  quantity    Int
  unitPrice   Float
  totalPrice  Float
  
  purchaseId  String
  purchase    Purchase @relation(fields: [purchaseId], references: [id])
  
  productId   String
  product     Product  @relation(fields: [productId], references: [id])
  
  batchId     String?  // Created or assigned during reception
  batch       Batch?   @relation(fields: [batchId], references: [id])
}

// Sales
model Sale {
  id            String     @id @default(uuid())
  reference     String     @unique // Invoice Number
  status        SaleStatus @default(DRAFT)
  date          DateTime   @default(now())
  
  subTotal      Float
  taxTotal      Float
  discount      Float      @default(0)
  paymentFees   Float      @default(0) // Extra fees (e.g. 1% for Cash)
  totalAmount   Float
  
  customerId    String
  customer      Customer   @relation(fields: [customerId], references: [id])
  userId        String
  user          User       @relation(fields: [userId], references: [id])
  
  warehouseId   String
  warehouse     Warehouse  @relation(fields: [warehouseId], references: [id]) // Where stock is taken from
  
  items         SaleItem[]
  payments      Payment[]
}

model SaleItem {
  id          String   @id @default(uuid())
  quantity    Int
  unitPrice   Float
  totalPrice  Float
  
  saleId      String
  sale        Sale     @relation(fields: [saleId], references: [id])
  
  productId   String
  product     Product  @relation(fields: [productId], references: [id])
  
  batchId     String?  // Specific batch being sold (FEFO - First Expired First Out)
  batch       Batch?   @relation(fields: [batchId], references: [id])
}

// Internal Transfers
model Transfer {
  id              String   @id @default(uuid())
  reference       String   @unique
  date            DateTime @default(now())
  status          String   @default("PENDING") // PENDING, COMPLETED, CANCELLED
  
  fromWarehouseId String
  fromWarehouse   Warehouse @relation("FromWarehouse", fields: [fromWarehouseId], references: [id])
  
  toWarehouseId   String
  toWarehouse     Warehouse @relation("ToWarehouse", fields: [toWarehouseId], references: [id])
  
  items           TransferItem[]
}

model TransferItem {
  id          String   @id @default(uuid())
  quantity    Int
  
  transferId  String
  transfer    Transfer @relation(fields: [transferId], references: [id])
  
  productId   String
  product     Product  @relation(fields: [productId], references: [id])
  
  batchId     String?
}

// 5. Finance
model Payment {
  id            String        @id @default(uuid())
  amount        Float
  date          DateTime      @default(now())
  method        PaymentMethod
  reference     String?       // Check number, Transaction ID
  
  purchaseId    String?
  purchase      Purchase?     @relation(fields: [purchaseId], references: [id])
  
  saleId        String?
  sale          Sale?         @relation(fields: [saleId], references: [id])
}

model Expense {
  id          String   @id @default(uuid())
  description String
  amount      Float
  category    String   // Rent, Utilities, Transport
  date        DateTime @default(now())
}
